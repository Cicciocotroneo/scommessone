<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      max-width: 1200px;
    }
    .hero-section {
      background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
      color: white;
      border-radius: 10px;
      padding: 3rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .card {
      transition: transform 0.3s;
      margin-bottom: 1.5rem;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    .card-header {
      background-color: #0d6efd;
      color: white;
      border-radius: 8px 8px 0 0 !important;
      font-weight: bold;
    }
    .btn-primary {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }
    .btn-primary:hover {
      background-color: #0b5ed7;
      border-color: #0a58ca;
    }
    .feature-icon {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: #0d6efd;
    }
    #loginForm, #registerForm {
      padding: 2rem;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    .nav-tabs .nav-link {
      border: none;
      color: #495057;
      font-weight: 500;
    }
    .nav-tabs .nav-link.active {
      color: #0d6efd;
      background-color: transparent;
      border-bottom: 3px solid #0d6efd;
    }
    .alert {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <!-- Hero Section -->
    <div class="hero-section text-center">
      <h1 class="display-4 fw-bold">Sistema Torneo Previsioni Calcio</h1>
      <p class="lead">Metti alla prova le tue abilità di pronostico e sfida i tuoi amici!</p>
    </div>
    
    <!-- Features Section -->
    <div class="row mb-5">
      <div class="col-md-4 text-center">
        <div class="card h-100">
          <div class="card-body">
            <div class="feature-icon">
              <i class="fas fa-futbol"></i>
            </div>
            <h3>Previsioni Partite</h3>
            <p>Prevedi risultati esatti, segni e marcatori per guadagnare punti e salire in classifica.</p>
          </div>
        </div>
      </div>
      <div class="col-md-4 text-center">
        <div class="card h-100">
          <div class="card-body">
            <div class="feature-icon">
              <i class="fas fa-trophy"></i>
            </div>
            <h3>Leghe Multiple</h3>
            <p>Partecipa a più leghe contemporaneamente per sfidare diversi gruppi di amici o colleghi.</p>
          </div>
        </div>
      </div>
      <div class="col-md-4 text-center">
        <div class="card h-100">
          <div class="card-body">
            <div class="feature-icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <h3>Classifiche in Tempo Reale</h3>
            <p>Segui l'andamento dei tuoi pronostici e la tua posizione nelle classifiche settimanali e generali.</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Auth Section -->
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header text-center py-3">
            <ul class="nav nav-tabs card-header-tabs justify-content-center" id="authTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button" role="tab" aria-controls="login" aria-selected="true">Accedi</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab" aria-controls="register" aria-selected="false">Registrati</button>
              </li>
            </ul>
          </div>
          <div class="card-body">
            <div class="tab-content" id="authTabsContent">
              <!-- Login Form -->
              <div class="tab-pane fade show active" id="login" role="tabpanel" aria-labelledby="login-tab">
                <div class="alert alert-danger" id="loginAlert" role="alert"></div>
                <form id="loginForm">
                  <div class="mb-3">
                    <label for="loginEmail" class="form-label">Email</label>
                    <input type="email" class="form-control" id="loginEmail" required>
                  </div>
                  <div class="mb-3">
                    <label for="loginPassword" class="form-label">Password</label>
                    <input type="password" class="form-control" id="loginPassword" required>
                  </div>
                  <button type="submit" class="btn btn-primary w-100">Accedi</button>
                </form>
              </div>
              
              <!-- Register Form -->
              <div class="tab-pane fade" id="register" role="tabpanel" aria-labelledby="register-tab">
                <div class="alert alert-danger" id="registerAlert" role="alert"></div>
                <form id="registerForm">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="registerNome" class="form-label">Nome</label>
                      <input type="text" class="form-control" id="registerNome" required>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="registerCognome" class="form-label">Cognome</label>
                      <input type="text" class="form-control" id="registerCognome" required>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="registerEmail" class="form-label">Email</label>
                    <input type="email" class="form-control" id="registerEmail" required>
                  </div>
                  <div class="mb-3">
                    <label for="registerPassword" class="form-label">Password</label>
                    <input type="password" class="form-control" id="registerPassword" required minlength="6">
                  </div>
                  <div class="mb-3">
                    <label for="registerPasswordConfirm" class="form-label">Conferma Password</label>
                    <input type="password" class="form-control" id="registerPasswordConfirm" required minlength="6">
                  </div>
                  <button type="submit" class="btn btn-primary w-100">Registrati</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Controlla se l'utente è già loggato
    function checkAuth() {
      const token = localStorage.getItem('torneo_token');
      if (token) {
        // Verifica il token
        fetch('<?= ScriptApp.getService().getUrl() ?>', {
          method: 'POST',
          contentType: 'application/json',
          payload: JSON.stringify({
            action: 'verifySession',
            token: token
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Salva i dati utente
            localStorage.setItem('torneo_user', JSON.stringify(data.data));
            // Reindirizza alla dashboard
            window.location.href = '<?= ScriptApp.getService().getUrl() ?>?v=dashboard';
          } else {
            // Token non valido, rimuovilo
            localStorage.removeItem('torneo_token');
            localStorage.removeItem('torneo_user');
          }
        })
        .catch(error => {
          console.error('Errore durante la verifica del token:', error);
        });
      }
    }

    // Al caricamento della pagina
    document.addEventListener('DOMContentLoaded', function() {
      // Controlla l'autenticazione
      checkAuth();
      
      // Gestione del form di login
      document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        // Nascondi eventuali alert precedenti
        document.getElementById('loginAlert').style.display = 'none';
        
        // Invia richiesta di login
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              // Memorizza il token e i dati utente
              localStorage.setItem('torneo_token', result.token);
              localStorage.setItem('torneo_user', JSON.stringify(result.user));
              
              // Reindirizza alla dashboard
              window.location.href = '<?= ScriptApp.getService().getUrl() ?>?v=dashboard';
            } else {
              // Mostra messaggio di errore
              const alert = document.getElementById('loginAlert');
              alert.textContent = result.message;
              alert.style.display = 'block';
            }
          })
          .withFailureHandler(function(error) {
            const alert = document.getElementById('loginAlert');
            alert.textContent = 'Errore durante il login: ' + error.message;
            alert.style.display = 'block';
          })
          .doPost({
            postData: {
              contents: JSON.stringify({
                action: 'login',
                email: email,
                password: password
              })
            }
          });
      });
      
      // Gestione del form di registrazione
      document.getElementById('registerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const nome = document.getElementById('registerNome').value;
        const cognome = document.getElementById('registerCognome').value;
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
        const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
        
        // Nascondi eventuali alert precedenti
        document.getElementById('registerAlert').style.display = 'none';
        
        // Verifica che le password coincidano
        if (password !== passwordConfirm) {
          const alert = document.getElementById('registerAlert');
          alert.textContent = 'Le password non coincidono';
          alert.style.display = 'block';
          return;
        }
        
        // Invia richiesta di registrazione
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              // Autologin
              google.script.run
                .withSuccessHandler(function(loginResult) {
                  if (loginResult.success) {
                    // Memorizza il token e i dati utente
                    localStorage.setItem('torneo_token', loginResult.token);
                    localStorage.setItem('torneo_user', JSON.stringify(loginResult.user));
                    
                    // Reindirizza alla dashboard
                    window.location.href = '<?= ScriptApp.getService().getUrl() ?>?v=dashboard';
                  } else {
                    // Reindirizza alla tab di login
                    document.getElementById('login-tab').click();
                  }
                })
                .doPost({
                  postData: {
                    contents: JSON.stringify({
                      action: 'login',
                      email: email,
                      password: password
                    })
                  }
                });
            } else {
              // Mostra messaggio di errore
              const alert = document.getElementById('registerAlert');
              alert.textContent = result.message;
              alert.style.display = 'block';
            }
          })
          .withFailureHandler(function(error) {
            const alert = document.getElementById('registerAlert');
            alert.textContent = 'Errore durante la registrazione: ' + error.message;
            alert.style.display = 'block';
          })
          .doPost({
            postData: {
              contents: JSON.stringify({
                action: 'register',
                nome: nome,
                cognome: cognome,
                email: email,
                password: password
              })
            }
          });
      });
    });
  </script>
</body>
</html>
