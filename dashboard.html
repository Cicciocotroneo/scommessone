<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      max-width: 1200px;
    }
    .sidebar {
      background-color: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      height: 100%;
    }
    .sidebar .nav-link {
      color: #333;
      padding: 10px 15px;
      border-radius: 5px;
      margin-bottom: 5px;
      transition: all 0.3s;
    }
    .sidebar .nav-link:hover {
      background-color: #f8f9fa;
    }
    .sidebar .nav-link.active {
      background-color: #0d6efd;
      color: white;
    }
    .sidebar .nav-link i {
      margin-right: 10px;
    }
    .content-area {
      background-color: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      min-height: 85vh;
    }
    .auth-info {
      background-color: #f8f9fa;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 15px;
    }
    .user-name {
      font-weight: bold;
    }
    .card {
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }
    .card-header {
      background-color: #0d6efd;
      color: white;
      border-radius: 8px 8px 0 0 !important;
      font-weight: bold;
    }
    .btn-primary {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }
    .btn-outline-primary {
      color: #0d6efd;
      border-color: #0d6efd;
    }
    .prediction-form {
      background-color: #f8f9fa;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .match-card {
      border-left: 4px solid #0d6efd;
    }
    .badge-primary {
      background-color: #0d6efd;
    }
    .text-primary {
      color: #0d6efd !important;
    }
    table.standings {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      border-radius: 8px;
      overflow: hidden;
    }
    table.standings th {
      background-color: #0d6efd;
      color: white;
      font-weight: normal;
    }
    table.standings tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    table.standings td, table.standings th {
      padding: 10px;
      text-align: center;
    }
    .tab-content {
      padding: 20px 0;
    }
    .alert {
      margin-bottom: 15px;
    }
    .game-date {
      font-size: 0.9rem;
      color: #6c757d;
    }
    #content-container {
      display: none;
    }
    #loadingSpinner {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 85vh;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 mb-4">
        <div class="sidebar">
          <div class="auth-info mb-4">
            <div class="user-name" id="userDisplayName">...</div>
            <div class="user-email small text-muted" id="userEmail">...</div>
          </div>
          
          <div class="nav flex-column nav-pills" id="dashboard-tab" role="tablist">
            <a class="nav-link active" id="home-tab" data-bs-toggle="pill" href="#home" role="tab">
              <i class="fas fa-home"></i> Home
            </a>
            <a class="nav-link" id="leghe-tab" data-bs-toggle="pill" href="#leghe" role="tab">
              <i class="fas fa-trophy"></i> Le mie leghe
            </a>
            <a class="nav-link" id="previsioni-tab" data-bs-toggle="pill" href="#previsioni" role="tab">
              <i class="fas fa-futbol"></i> Previsioni
            </a>
            <a class="nav-link" id="classifiche-tab" data-bs-toggle="pill" href="#classifiche" role="tab">
              <i class="fas fa-chart-line"></i> Classifiche
            </a>
            <hr>
            <a class="nav-link text-danger" href="#" id="logoutBtn">
              <i class="fas fa-sign-out-alt"></i> Esci
            </a>
          </div>
        </div>
      </div>
      
      <!-- Content Area -->
      <div class="col-md-9">
        <div id="loadingSpinner">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Caricamento...</span>
          </div>
        </div>
        
        <div id="content-container" class="content-area">
          <div class="tab-content">
            <!-- Home Tab -->
            <div class="tab-pane fade show active" id="home" role="tabpanel">
              <h2 class="mb-4">Dashboard</h2>
              
              <div class="alert alert-info" id="welcomeAlert">
                <h5 class="alert-heading">Benvenuto nel Sistema Torneo Previsioni!</h5>
                <p>Usa il menu laterale per navigare tra le varie sezioni.</p>
              </div>
              
              <div class="card mb-4">
                <div class="card-header">
                  <i class="fas fa-chart-pie me-2"></i> Riepilogo
                </div>
                <div class="card-body">
                  <div class="row text-center">
                    <div class="col-md-4 mb-3">
                      <h5 id="totalLeagues">0</h5>
                      <p class="text-muted">Leghe</p>
                    </div>
                    <div class="col-md-4 mb-3">
                      <h5 id="totalPredictions">0</h5>
                      <p class="text-muted">Previsioni</p>
                    </div>
                    <div class="col-md-4 mb-3">
                      <h5 id="correctPredictions">0</h5>
                      <p class="text-muted">Previsioni corrette</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="card">
                    <div class="card-header">
                      <i class="fas fa-futbol me-2"></i> Prossime partite
                    </div>
                    <div class="card-body">
                      <div id="nextMatchesList">
                        <p class="text-center text-muted">Nessuna partita in programma</p>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card">
                    <div class="card-header">
                      <i class="fas fa-trophy me-2"></i> Classifiche migliori
                    </div>
                    <div class="card-body">
                      <div id="topRankingsList">
                        <p class="text-center text-muted">Nessuna classifica disponibile</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Leghe Tab -->
            <div class="tab-pane fade" id="leghe" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Le mie leghe</h2>
                <button class="btn btn-primary" id="btnShowJoinLeague">
                  <i class="fas fa-plus me-1"></i> Iscriviti a una lega
                </button>
              </div>
              
              <div id="joinLeagueForm" class="card mb-4" style="display: none;">
                <div class="card-header">
                  Iscriviti a una nuova lega
                </div>
                <div class="card-body">
                  <div class="alert alert-danger" id="joinLeagueAlert" style="display: none;"></div>
                  <div class="alert alert-success" id="joinLeagueSuccess" style="display: none;"></div>
                  
                  <div id="availableLeaguesList">
                    <p class="text-center text-muted">Caricamento leghe disponibili...</p>
                  </div>
                </div>
              </div>
              
              <div id="myLeaguesList">
                <p class="text-center text-muted">Nessuna lega trovata</p>
              </div>
            </div>
            
            <!-- Previsioni Tab -->
            <div class="tab-pane fade" id="previsioni" role="tabpanel">
              <h2 class="mb-4">Previsioni</h2>
              
              <div class="card mb-4">
                <div class="card-header">
                  Seleziona lega e giornata
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="previsioni-league-select" class="form-label">Lega</label>
                      <select class="form-select" id="previsioni-league-select">
                        <option value="">Seleziona una lega</option>
                      </select>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="previsioni-gameweek-select" class="form-label">Giornata</label>
                      <select class="form-select" id="previsioni-gameweek-select" disabled>
                        <option value="">Seleziona prima una lega</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              
              <div id="matchesForPrediction" style="display: none;">
                <h3 class="mb-3">Partite della giornata</h3>
                <div id="predictionMatchesList">
                  <!-- Le partite verranno caricate qui -->
                </div>
              </div>
              
              <div id="myPredictionsList">
                <h3 class="mb-3">Le mie previsioni recenti</h3>
                <div class="table-responsive">
                  <table class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th>Partita</th>
                        <th>Previsione</th>
                        <th>Risultato</th>
                        <th>Punti</th>
                        <th>Data</th>
                      </tr>
                    </thead>
                    <tbody id="predictionsTableBody">
                      <tr>
                        <td colspan="5" class="text-center">Nessuna previsione trovata</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <!-- Classifiche Tab -->
            <div class="tab-pane fade" id="classifiche" role="tabpanel">
              <h2 class="mb-4">Classifiche</h2>
              
              <div class="card mb-4">
                <div class="card-header">
                  Seleziona lega e giornata
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="classifiche-league-select" class="form-label">Lega</label>
                      <select class="form-select" id="classifiche-league-select">
                        <option value="">Seleziona una lega</option>
                      </select>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="classifiche-type-select" class="form-label">Tipo classifica</label>
                      <select class="form-select" id="classifiche-type-select" disabled>
                        <option value="total">Classifica generale</option>
                        <option value="weekly">Classifica settimanale</option>
                      </select>
                    </div>
                  </div>
                  <div class="row" id="gameweek-selector-row" style="display: none;">
                    <div class="col-md-6 mb-3">
                      <label for="classifiche-gameweek-select" class="form-label">Giornata</label>
                      <select class="form-select" id="classifiche-gameweek-select">
                        <option value="">Seleziona una giornata</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              
              <div id="standingsTable" style="display: none;">
                <h3 class="mb-3" id="standingsTitle">Classifica</h3>
                <div class="table-responsive">
                  <table class="table table-striped table-hover standings">
                    <thead>
                      <tr>
                        <th>Pos.</th>
                        <th>Utente</th>
                        <th>Punti</th>
                        <th>Prev. Corrette</th>
                        <th>Prev. Totali</th>
                        <th>% Corrette</th>
                      </tr>
                    </thead>
                    <tbody id="standingsTableBody">
                      <!-- I dati verranno caricati qui -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal per inserimento previsione -->
  <div class="modal fade" id="predictionModal" tabindex="-1" aria-labelledby="predictionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="predictionModalLabel">Inserisci previsione</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="predictionForm">
            <input type="hidden" id="predictionMatchId">
            
            <div class="mb-3">
              <label class="form-label fw-bold" id="matchTeamsLabel">Squadra A vs Squadra B</label>
              <div class="game-date mb-3" id="matchDateLabel">Data: 00/00/0000 00:00</div>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Segno (1 punto)</label>
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="segnoPrevisione" id="segno1" value="1" autocomplete="off" required>
                <label class="btn btn-outline-primary" for="segno1">1</label>
                
                <input type="radio" class="btn-check" name="segnoPrevisione" id="segnoX" value="X" autocomplete="off">
                <label class="btn btn-outline-primary" for="segnoX">X</label>
                
                <input type="radio" class="btn-check" name="segnoPrevisione" id="segno2" value="2" autocomplete="off">
                <label class="btn btn-outline-primary" for="segno2">2</label>
              </div>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Risultato esatto (+2 punti)</label>
              <div class="row">
                <div class="col-5">
                  <input type="number" class="form-control" id="risultatoCasa" min="0" required>
                </div>
                <div class="col-2 text-center pt-2">
                  <span class="fw-bold">-</span>
                </div>
                <div class="col-5">
                  <input type="number" class="form-control" id="risultatoTrasferta" min="0" required>
                </div>
              </div>
            </div>
            
            <div class="mb-3" id="marcatoriGroup">
              <label class="form-label">Marcatori (+2 punti)</label>
              <small class="text-muted d-block mb-2">Inserisci i nomi dei marcatori separati da virgola</small>
              <textarea class="form-control" id="marcatori" rows="2"></textarea>
              <small class="text-muted">Non necessario se prevedi 0-0</small>
            </div>
            
            <div class="alert alert-danger" id="predictionAlert" style="display: none;"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" class="btn btn-primary" id="submitPrediction">Salva previsione</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Variabili globali
    let currentUser = null;
    let userLeagues = [];
    let allGameweeks = {};
    const apiUrl = '<?= ScriptApp.getService().getUrl() ?>';
    
    // Funzione per verificare l'autenticazione dell'utente
    function checkAuth() {
      const token = localStorage.getItem('torneo_token');
      if (!token) {
        // Reindirizza alla pagina di login
        window.location.href = apiUrl;
        return;
      }
      
      // Carica i dati utente dal localStorage
      const userData = localStorage.getItem('torneo_user');
      if (userData) {
        currentUser = JSON.parse(userData);
        
        // Imposta i dati utente nell'interfaccia
        document.getElementById('userDisplayName').textContent = `${currentUser.nome} ${currentUser.cognome}`;
        document.getElementById('userEmail').textContent = currentUser.email;
        
        // Carica i dati iniziali
        loadInitialData();
      } else {
        // Reindirizza alla pagina di login
        window.location.href = apiUrl;
      }
    }
    
    // Carica i dati iniziali della dashboard
    function loadInitialData() {
      // Mostra il contenuto principale
      document.getElementById('loadingSpinner').style.display = 'none';
      document.getElementById('content-container').style.display = 'block';
      
      // Carica le leghe dell'utente
      loadUserLeagues();
      
      // Carica le previsioni recenti dell'utente
      loadUserPredictions();
    }
    
    // Carica le leghe dell'utente
    function loadUserLeagues() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            userLeagues = result.data;
            
            // Aggiorna il contatore delle leghe
            document.getElementById('totalLeagues').textContent = userLeagues.length;
            
            // Popola il selettore delle leghe nelle previsioni
            const leagueSelect = document.getElementById('previsioni-league-select');
            const classificheLeagueSelect = document.getElementById('classifiche-league-select');
            
            leagueSelect.innerHTML = '<option value="">Seleziona una lega</option>';
            classificheLeagueSelect.innerHTML = '<option value="">Seleziona una lega</option>';
            
            userLeagues.forEach(league => {
              leagueSelect.innerHTML += `<option value="${league.id}">${league.nome}</option>`;
              classificheLeagueSelect.innerHTML += `<option value="${league.id}">${league.nome}</option>`;
            });
            
            // Aggiorna la lista delle leghe dell'utente
            updateMyLeaguesList();
            
            // Carica le leghe disponibili
            loadAvailableLeagues();
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'getUserLeagues',
              userId: currentUser.id
            })
          }
        });
    }
    
    // Aggiorna la lista delle leghe dell'utente
    function updateMyLeaguesList() {
      const leaguesContainer = document.getElementById('myLeaguesList');
      
      if (userLeagues.length === 0) {
        leaguesContainer.innerHTML = '<p class="text-center text-muted">Non sei iscritto a nessuna lega</p>';
        return;
      }
      
      let html = '';
      
      userLeagues.forEach(league => {
        html += `
          <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>${league.nome}</span>
              <button class="btn btn-sm btn-primary view-league-btn" data-league-id="${league.id}">
                <i class="fas fa-eye me-1"></i> Visualizza
              </button>
            </div>
            <div class="card-body">
              <p class="mb-1">${league.descrizione || 'Nessuna descrizione'}</p>
              <small class="text-muted">Creata il ${new Date(league.dataCreazione).toLocaleDateString()}</small>
            </div>
          </div>
        `;
      });
      
      leaguesContainer.innerHTML = html;
      
      // Aggiungi event listener ai pulsanti
      document.querySelectorAll('.view-league-btn').forEach(button => {
        button.addEventListener('click', function() {
          const leagueId = this.getAttribute('data-league-id');
          document.getElementById('classifiche-league-select').value = leagueId;
          document.getElementById('classifiche-tab').click();
          loadLeagueStandings(leagueId);
        });
      });
    }
    
    // Carica le leghe disponibili per l'iscrizione
    function loadAvailableLeagues() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            const allLeagues = result.data;
            const availableLeaguesContainer = document.getElementById('availableLeaguesList');
            
            // Filtra le leghe a cui l'utente non è già iscritto
            const userLeagueIds = userLeagues.map(league => league.id);
            const availableLeagues = allLeagues.filter(league => !userLeagueIds.includes(league.id));
            
            if (availableLeagues.length === 0) {
              availableLeaguesContainer.innerHTML = '<p class="text-center text-muted">Non ci sono leghe disponibili per l\'iscrizione</p>';
              return;
            }
            
            let html = '<div class="list-group">';
            
            availableLeagues.forEach(league => {
              html += `
                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                  <div>
                    <h5 class="mb-1">${league.nome}</h5>
                    <p class="mb-1 small">${league.descrizione || 'Nessuna descrizione'}</p>
                    <small class="text-muted">Creata il ${new Date(league.dataCreazione).toLocaleDateString()}</small>
                  </div>
                  <button class="btn btn-sm btn-primary join-league-btn" data-league-id="${league.id}">
                    <i class="fas fa-plus me-1"></i> Iscriviti
                  </button>
                </div>
              `;
            });
            
            html += '</div>';
            availableLeaguesContainer.innerHTML = html;
            
            // Aggiungi event listener ai pulsanti
            document.querySelectorAll('.join-league-btn').forEach(button => {
              button.addEventListener('click', function() {
                const leagueId = this.getAttribute('data-league-id');
                requestLeagueMembership(leagueId);
              });
            });
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'getAllLeagues'
            })
          }
        });
    }
    
    // Richiedi iscrizione a una lega
    function requestLeagueMembership(leagueId) {
      google.script.run
        .withSuccessHandler(function(result) {
          const successAlert = document.getElementById('joinLeagueSuccess');
          const dangerAlert = document.getElementById('joinLeagueAlert');
          
          if (result.success) {
            dangerAlert.style.display = 'none';
            successAlert.textContent = result.message;
            successAlert.style.display = 'block';
            
            // Aggiorna la lista delle leghe disponibili
            loadAvailableLeagues();
          } else {
            successAlert.style.display = 'none';
            dangerAlert.textContent = result.message;
            dangerAlert.style.display = 'block';
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'requestLeagueMembership',
              userId: currentUser.id,
              leagueId: leagueId
            })
          }
        });
    }
    
    // Carica le previsioni dell'utente
    function loadUserPredictions() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            const predictions = result.data;
            
            // Aggiorna i contatori
            let totalCorrect = 0;
            predictions.forEach(pred => {
              if (pred.puntiOttenuti > 0) totalCorrect++;
            });
            
            document.getElementById('totalPredictions').textContent = predictions.length;
            document.getElementById('correctPredictions').textContent = totalCorrect;
            
            // Aggiorna la tabella delle previsioni
            updatePredictionsTable(predictions);
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'getUserPredictions',
              userId: currentUser.id
            })
          }
        });
    }
    
    // Aggiorna la tabella delle previsioni
    function updatePredictionsTable(predictions) {
      const tableBody = document.getElementById('predictionsTableBody');
      
      if (predictions.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Nessuna previsione trovata</td></tr>';
        return;
      }
      
      let html = '';
      
      // Limita a 10 previsioni più recenti
      const recentPredictions = predictions.sort((a, b) => new Date(b.dataInserimento) - new Date(a.dataInserimento)).slice(0, 10);
      
      recentPredictions.forEach(pred => {
        html += `
          <tr>
            <td>${pred.partita}</td>
            <td>${pred.segnoPrevisione} (${pred.risultatoCasaPrevisione}-${pred.risultatoTrasfertaPrevisione})</td>
            <td>${pred.risultatoReale}</td>
            <td>${pred.puntiOttenuti}</td>
            <td>${new Date(pred.dataInserimento).toLocaleDateString()}</td>
          </tr>
        `;
      });
      
      tableBody.innerHTML = html;
    }
    
    // Carica le giornate di una lega
    function loadLeagueGameweeks(leagueId, selectElement, callback) {
      if (allGameweeks[leagueId]) {
        populateGameweekSelect(selectElement, allGameweeks[leagueId]);
        if (callback) callback(allGameweeks[leagueId]);
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            const gameweeks = result.data;
            allGameweeks[leagueId] = gameweeks;
            
            populateGameweekSelect(selectElement, gameweeks);
            if (callback) callback(gameweeks);
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'getLeagueGameweeks',
              legaId: leagueId
            })
          }
        });
    }
    
    // Popola il selettore delle giornate
    function populateGameweekSelect(selectElement, gameweeks) {
      selectElement.innerHTML = '<option value="">Seleziona una giornata</option>';
      
      if (gameweeks.length === 0) {
        selectElement.disabled = true;
        return;
      }
      
      selectElement.disabled = false;
      
      gameweeks.forEach(gameweek => {
        // Formatta le date
        const dataInizio = new Date(gameweek.dataInizio).toLocaleDateString();
        const dataFine = new Date(gameweek.dataFine).toLocaleDateString();
        
        selectElement.innerHTML += `
          <option value="${gameweek.id}">Giornata ${gameweek.numero} (${dataInizio} - ${dataFine})</option>
        `;
      });
    }
    
    // Carica le partite di una giornata
    function loadGameweekMatches(gameweekId, callback) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success && callback) {
            callback(result.data);
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'getGameweekMatches',
              gameweekId: gameweekId
            })
          }
        });
    }
    
    // Carica la classifica di una lega
    function loadLeagueStandings(leagueId, gameweekId = null) {
      document.getElementById('classifiche-type-select').disabled = false;
      
      const isWeekly = document.getElementById('classifiche-type-select').value === 'weekly';
      const action = isWeekly ? 'getWeeklyLeagueStandings' : 'getLeagueStandings';
      const postData = isWeekly 
        ? { action, legaId: leagueId, gameweekId } 
        : { action, legaId: leagueId };
      
      // Se è settimanale ma non è selezionata una giornata, non fare nulla
      if (isWeekly && !gameweekId) return;
      
      // Aggiorna il titolo della classifica
      document.getElementById('standingsTitle').textContent = isWeekly 
        ? 'Classifica Settimanale' 
        : 'Classifica Generale';
      
      // Mostra il pannello della classifica
      document.getElementById('standingsTable').style.display = 'block';
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            const standings = result.data;
            const tableBody = document.getElementById('standingsTableBody');
            
            if (standings.length === 0) {
              tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Nessun dato disponibile</td></tr>';
              return;
            }
            
            let html = '';
            
            standings.forEach((user, index) => {
              html += `
                <tr>
                  <td>${index + 1}</td>
                  <td>${user.nome} ${user.cognome}</td>
                  <td class="fw-bold">${user.punti}</td>
                  <td>${user.previsioniCorrette}</td>
                  <td>${user.previsioniTotali}</td>
                  <td>${user.percentualeCorrette}%</td>
                </tr>
              `;
            });
            
            tableBody.innerHTML = html;
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify(postData)
          }
        });
    }
    
    // Inserisci una previsione
    function submitPrediction() {
      const matchId = document.getElementById('predictionMatchId').value;
      const segnoPrevisione = document.querySelector('input[name="segnoPrevisione"]:checked')?.value;
      const risultatoCasa = document.getElementById('risultatoCasa').value;
      const risultatoTrasferta = document.getElementById('risultatoTrasferta').value;
      const marcatori = document.getElementById('marcatori').value;
      
      // Validazione
      if (!segnoPrevisione) {
        document.getElementById('predictionAlert').textContent = 'Seleziona un segno';
        document.getElementById('predictionAlert').style.display = 'block';
        return;
      }
      
      if (risultatoCasa === '' || risultatoTrasferta === '') {
        document.getElementById('predictionAlert').textContent = 'Inserisci un risultato completo';
        document.getElementById('predictionAlert').style.display = 'block';
        return;
      }
      
      // Verifica che il segno sia coerente con il risultato
      const goalCasa = parseInt(risultatoCasa);
      const goalTrasferta = parseInt(risultatoTrasferta);
      
      let segnoRisultato;
      if (goalCasa > goalTrasferta) {
        segnoRisultato = '1';
      } else if (goalCasa < goalTrasferta) {
        segnoRisultato = '2';
      } else {
        segnoRisultato = 'X';
      }
      
      if (segnoPrevisione !== segnoRisultato) {
        document.getElementById('predictionAlert').textContent = 'Il segno non corrisponde al risultato inserito';
        document.getElementById('predictionAlert').style.display = 'block';
        return;
      }
      
      // Se il risultato è 0-0, non servono marcatori
      const isMarcatoriRequired = goalCasa > 0 || goalTrasferta > 0;
      
      if (isMarcatoriRequired && !marcatori.trim()) {
        document.getElementById('predictionAlert').textContent = 'Inserisci almeno un marcatore';
        document.getElementById('predictionAlert').style.display = 'block';
        return;
      }
      
      // Salva la previsione
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // Chiudi il modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('predictionModal'));
            modal.hide();
            
            // Aggiorna la lista delle previsioni
            loadUserPredictions();
            
            // Ricarica le partite per la giornata selezionata
            const gameweekId = document.getElementById('previsioni-gameweek-select').value;
            if (gameweekId) {
              loadGameweekMatches(gameweekId, updatePredictionMatchesList);
            }
          } else {
            document.getElementById('predictionAlert').textContent = result.message;
            document.getElementById('predictionAlert').style.display = 'block';
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'createPrediction',
              utenteId: currentUser.id,
              partitaId: matchId,
              segnoPrevisione: segnoPrevisione,
              risultatoCasaPrevisione: goalCasa,
              risultatoTrasfertaPrevisione: goalTrasferta,
              marcatoriPrevisione: marcatori
            })
          }
        });
    }
    
    // Aggiorna la lista delle partite per le previsioni
    function updatePredictionMatchesList(matches) {
      const matchesContainer = document.getElementById('predictionMatchesList');
      document.getElementById('matchesForPrediction').style.display = 'block';
      
      if (matches.length === 0) {
        matchesContainer.innerHTML = '<p class="text-center text-muted">Nessuna partita trovata</p>';
        return;
      }
      
      let html = '';
      
      matches.forEach(match => {
        // Formatta la data
        const matchDate = new Date(match.dataOra).toLocaleString();
        
        const isMatchFinished = match.stato === 'completata';
        const isMatchActive = match.stato === 'in corso';
        const canPredict = match.stato === 'non iniziata';
        
        let statusBadge = '';
        if (isMatchFinished) {
          statusBadge = '<span class="badge bg-success">Completata</span>';
        } else if (isMatchActive) {
          statusBadge = '<span class="badge bg-warning text-dark">In corso</span>';
        } else {
          statusBadge = '<span class="badge bg-info text-dark">Non iniziata</span>';
        }
        
        let resultHtml = '';
        if (isMatchFinished || isMatchActive) {
          resultHtml = `<div class="match-result fw-bold">${match.risultatoCasa} - ${match.risultatoTrasferta}</div>`;
        }
        
        html += `
          <div class="card mb-3 match-card">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-5">
                  <div class="d-flex align-items-center">
                    <div>
                      <div class="fw-bold">${match.squadraCasa} - ${match.squadraTrasferta}</div>
                      <div class="game-date">${matchDate}</div>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 text-center">
                  ${statusBadge}
                  ${resultHtml}
                </div>
                <div class="col-md-4 text-end">
                  <button class="btn btn-primary ${canPredict ? '' : 'disabled'}" onclick="openPredictionModal('${match.id}', '${match.squadraCasa}', '${match.squadraTrasferta}', '${match.dataOra}')" ${canPredict ? '' : 'disabled'}>
                    ${canPredict ? '<i class="fas fa-edit me-1"></i> Inserisci previsione' : '<i class="fas fa-ban me-1"></i> Previsioni chiuse'}
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      
      matchesContainer.innerHTML = html;
    }
    
    // Apre il modal per inserire una previsione
    function openPredictionModal(matchId, squadraCasa, squadraTrasferta, dataOra) {
      // Imposta i dati della partita
      document.getElementById('predictionMatchId').value = matchId;
      document.getElementById('matchTeamsLabel').textContent = `${squadraCasa} vs ${squadraTrasferta}`;
      document.getElementById('matchDateLabel').textContent = `Data: ${new Date(dataOra).toLocaleString()}`;
      
      // Resetta il form
      document.getElementById('predictionForm').reset();
      document.getElementById('predictionAlert').style.display = 'none';
      
      // Mostra il modal
      const modal = new bootstrap.Modal(document.getElementById('predictionModal'));
      modal.show();
    }
    
    // Gestione eventi al caricamento della pagina
    document.addEventListener('DOMContentLoaded', function() {
      // Controlla l'autenticazione
      checkAuth();
      
      // Gestione del pulsante di logout
      document.getElementById('logoutBtn').addEventListener('click', function(e) {
        e.preventDefault();
        
        // Rimuovi i dati di sessione
        localStorage.removeItem('torneo_token');
        localStorage.removeItem('torneo_user');
        
        // Reindirizza alla pagina di login
        window.location.href = apiUrl;
      });
      
      // Gestione del pulsante per mostrare il form di iscrizione a una lega
      document.getElementById('btnShowJoinLeague').addEventListener('click', function() {
        const form = document.getElementById('joinLeagueForm');
        if (form.style.display === 'none') {
          form.style.display = 'block';
          this.innerHTML = '<i class="fas fa-minus me-1"></i> Nascondi';
        } else {
          form.style.display = 'none';
          this.innerHTML = '<i class="fas fa-plus me-1"></i> Iscriviti a una lega';
        }
      });
      
      // Gestione della selezione della lega per le previsioni
      document.getElementById('previsioni-league-select').addEventListener('change', function() {
        const leagueId = this.value;
        const gameweekSelect = document.getElementById('previsioni-gameweek-select');
        
        if (leagueId) {
          loadLeagueGameweeks(leagueId, gameweekSelect);
        } else {
          gameweekSelect.innerHTML = '<option value="">Seleziona prima una lega</option>';
          gameweekSelect.disabled = true;
          document.getElementById('matchesForPrediction').style.display = 'none';
        }
      });
      
      // Gestione della selezione della giornata per le previsioni
      document.getElementById('previsioni-gameweek-select').addEventListener('change', function() {
        const gameweekId = this.value;
        
        if (gameweekId) {
          loadGameweekMatches(gameweekId, updatePredictionMatchesList);
        } else {
          document.getElementById('matchesForPrediction').style.display = 'none';
        }
      });
      
      // Gestione della selezione della lega per le classifiche
      document.getElementById('classifiche-league-select').addEventListener('change', function() {
        const leagueId = this.value;
        
        if (leagueId) {
          // Abilita il selettore del tipo di classifica
          document.getElementById('classifiche-type-select').disabled = false;
          
          // Se è selezionata la classifica settimanale, carica le giornate
          if (document.getElementById('classifiche-type-select').value === 'weekly') {
            loadLeagueGameweeks(leagueId, document.getElementById('classifiche-gameweek-select'));
            document.getElementById('gameweek-selector-row').style.display = 'block';
          } else {
            // Carica la classifica generale
            loadLeagueStandings(leagueId);
          }
        } else {
          document.getElementById('classifiche-type-select').disabled = true;
          document.getElementById('gameweek-selector-row').style.display = 'none';
          document.getElementById('standingsTable').style.display = 'none';
        }
      });
      
      // Gestione della selezione del tipo di classifica
      document.getElementById('classifiche-type-select').addEventListener('change', function() {
        const leagueId = document.getElementById('classifiche-league-select').value;
        const isWeekly = this.value === 'weekly';
        
        if (leagueId) {
          if (isWeekly) {
            // Mostra il selettore della giornata
            document.getElementById('gameweek-selector-row').style.display = 'block';
            loadLeagueGameweeks(leagueId, document.getElementById('classifiche-gameweek-select'));
          } else {
            // Nascondi il selettore della giornata
            document.getElementById('gameweek-selector-row').style.display = 'none';
            // Carica la classifica generale
            loadLeagueStandings(leagueId);
          }
        }
      });
      
      // Gestione della selezione della giornata per le classifiche
      document.getElementById('classifiche-gameweek-select').addEventListener('change', function() {
        const leagueId = document.getElementById('classifiche-league-select').value;
        const gameweekId = this.value;
        
        if (leagueId && gameweekId) {
          loadLeagueStandings(leagueId, gameweekId);
        } else {
          document.getElementById('standingsTable').style.display = 'none';
        }
      });
      
      // Gestione del form di previsione
      document.getElementById('submitPrediction').addEventListener('click', submitPrediction);
      
      // Gestione dei radio button per il segno
      document.querySelectorAll('input[name="segnoPrevisione"]').forEach(radio => {
        radio.addEventListener('change', function() {
          // Se si seleziona un segno, aggiorna automaticamente il risultato
          if (this.value === '1') {
            document.getElementById('risultatoCasa').value = '1';
            document.getElementById('risultatoTrasferta').value = '0';
          } else if (this.value === 'X') {
            document.getElementById('risultatoCasa').value = '0';
            document.getElementById('risultatoTrasferta').value = '0';
          } else if (this.value === '2') {
            document.getElementById('risultatoCasa').value = '0';
            document.getElementById('risultatoTrasferta').value = '1';
          }
          
          // Se il risultato è 0-0, nascondi il campo marcatori
          const isMarcatoriRequired = (
            document.getElementById('risultatoCasa').value > 0 || 
            document.getElementById('risultatoTrasferta').value > 0
          );
          
          if (!isMarcatoriRequired) {
            document.getElementById('marcatori').value = '';
          }
        });
      });
      
      // Gestione del campo risultato
      document.getElementById('risultatoCasa').addEventListener('change', updatePredictionSign);
      document.getElementById('risultatoTrasferta').addEventListener('change', updatePredictionSign);
    });
    
    // Aggiorna il segno in base al risultato
    function updatePredictionSign() {
      const goalCasa = parseInt(document.getElementById('risultatoCasa').value) || 0;
      const goalTrasferta = parseInt(document.getElementById('risultatoTrasferta').value) || 0;
      
      // Seleziona il radio button corrispondente
      if (goalCasa > goalTrasferta) {
        document.getElementById('segno1').checked = true;
      } else if (goalCasa < goalTrasferta) {
        document.getElementById('segno2').checked = true;
      } else {
        document.getElementById('segnoX').checked = true;
      }
      
      // Mostra/nascondi il campo marcatori in base al risultato
      const isMarcatoriRequired = goalCasa > 0 || goalTrasferta > 0;
      if (!isMarcatoriRequired) {
        document.getElementById('marcatori').value = '';
      }
    }
  </script>
        loadInitialData();
      } else {
        // Reindirizza alla pagina di login
        window.location.href = apiUrl;
      }
    }
    
    // Carica i dati iniziali della dashboard
    function loadInitialData() {
      // Mostra il contenuto principale
      document.getElementById('loadingSpinner').style.display = 'none';
      document.getElementById('content-container').style.display = 'block';
      
      // Carica le leghe dell'utente
      loadUserLeagues();
      
      // Carica le previsioni recenti dell'utente
      loadUserPredictions();
    }
    
    // Carica le leghe dell'utente
    function loadUserLeagues() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            userLeagues = result.data;
            
            // Aggiorna il contatore delle leghe
            document.getElementById('totalLeagues').textContent = userLeagues.length;
            
            // Popola il selettore delle leghe nelle previsioni
            const leagueSelect = document.getElementById('previsioni-league-select');
            const classificheLeagueSelect = document.getElementById('classifiche-league-select');
            
            leagueSelect.innerHTML = '<option value="">Seleziona una lega</option>';
            classificheLeagueSelect.innerHTML = '<option value="">Seleziona una lega</option>';
            
            userLeagues.forEach(league => {
              leagueSelect.innerHTML += `<option value="${league.id}">${league.nome}</option>`;
              classificheLeagueSelect.innerHTML += `<option value="${league.id}">${league.nome}</option>`;
            });
            
            // Aggiorna la lista delle leghe dell'utente
            updateMyLeaguesList();
            
            // Carica le leghe disponibili
            loadAvailableLeagues();
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'getUserLeagues',
              userId: currentUser.id
            })
          }
        });
    }
    
    // Aggiorna la lista delle leghe dell'utente
    function updateMyLeaguesList() {
      const leaguesContainer = document.getElementById('myLeaguesList');
      
      if (userLeagues.length === 0) {
        leaguesContainer.innerHTML = '<p class="text-center text-muted">Non sei iscritto a nessuna lega</p>';
        return;
      }
      
      let html = '';
      
      userLeagues.forEach(league => {
        html += `
          <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>${league.nome}</span>
              <button class="btn btn-sm btn-primary view-league-btn" data-league-id="${league.id}">
                <i class="fas fa-eye me-1"></i> Visualizza
              </button>
            </div>
            <div class="card-body">
              <p class="mb-1">${league.descrizione || 'Nessuna descrizione'}</p>
              <small class="text-muted">Creata il ${new Date(league.dataCreazione).toLocaleDateString()}</small>
            </div>
          </div>
        `;
      });
      
      leaguesContainer.innerHTML = html;
      
      // Aggiungi event listener ai pulsanti
      document.querySelectorAll('.view-league-btn').forEach(button => {
        button.addEventListener('click', function() {
          const leagueId = this.getAttribute('data-league-id');
          document.getElementById('classifiche-league-select').value = leagueId;
          document.getElementById('classifiche-tab').click();
          loadLeagueStandings(leagueId);
        });
      });
    }
    
    // Carica le leghe disponibili per l'iscrizione
    function loadAvailableLeagues() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            const allLeagues = result.data;
            const availableLeaguesContainer = document.getElementById('availableLeaguesList');
            
            // Filtra le leghe a cui l'utente non è già iscritto
            const userLeagueIds = userLeagues.map(league => league.id);
            const availableLeagues = allLeagues.filter(league => !userLeagueIds.includes(league.id));
            
            if (availableLeagues.length === 0) {
              availableLeaguesContainer.innerHTML = '<p class="text-center text-muted">Non ci sono leghe disponibili per l\'iscrizione</p>';
              return;
            }
            
            let html = '<div class="list-group">';
            
            availableLeagues.forEach(league => {
              html += `
                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                  <div>
                    <h5 class="mb-1">${league.nome}</h5>
                    <p class="mb-1 small">${league.descrizione || 'Nessuna descrizione'}</p>
                    <small class="text-muted">Creata il ${new Date(league.dataCreazione).toLocaleDateString()}</small>
                  </div>
                  <button class="btn btn-sm btn-primary join-league-btn" data-league-id="${league.id}">
                    <i class="fas fa-plus me-1"></i> Iscriviti
                  </button>
                </div>
              `;
            });
            
            html += '</div>';
            availableLeaguesContainer.innerHTML = html;
            
            // Aggiungi event listener ai pulsanti
            document.querySelectorAll('.join-league-btn').forEach(button => {
              button.addEventListener('click', function() {
                const leagueId = this.getAttribute('data-league-id');
                requestLeagueMembership(leagueId);
              });
            });
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'getAllLeagues'
            })
          }
        });
    }
    
    // Richiedi iscrizione a una lega
    function requestLeagueMembership(leagueId) {
      google.script.run
        .withSuccessHandler(function(result) {
          const successAlert = document.getElementById('joinLeagueSuccess');
          const dangerAlert = document.getElementById('joinLeagueAlert');
          
          if (result.success) {
            dangerAlert.style.display = 'none';
            successAlert.textContent = result.message;
            successAlert.style.display = 'block';
            
            // Aggiorna la lista delle leghe disponibili
            loadAvailableLeagues();
          } else {
            successAlert.style.display = 'none';
            dangerAlert.textContent = result.message;
            dangerAlert.style.display = 'block';
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'requestLeagueMembership',
              userId: currentUser.id,
              leagueId: leagueId
            })
          }
        });
    }
    
    // Carica le previsioni dell'utente
    function loadUserPredictions() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            const predictions = result.data;
            
            // Aggiorna i contatori
            let totalCorrect = 0;
            predictions.forEach(pred => {
              if (pred.puntiOttenuti > 0) totalCorrect++;
            });
            
            document.getElementById('totalPredictions').textContent = predictions.length;
            document.getElementById('correctPredictions').textContent = totalCorrect;
            
            // Aggiorna la tabella delle previsioni
            updatePredictionsTable(predictions);
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'getUserPredictions',
              userId: currentUser.id
            })
          }
        });
    }
    
    // Aggiorna la tabella delle previsioni
    function updatePredictionsTable(predictions) {
      const tableBody = document.getElementById('predictionsTableBody');
      
      if (predictions.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Nessuna previsione trovata</td></tr>';
        return;
      }
      
      let html = '';
      
      // Limita a 10 previsioni più recenti
      const recentPredictions = predictions.sort((a, b) => new Date(b.dataInserimento) - new Date(a.dataInserimento)).slice(0, 10);
      
      recentPredictions.forEach(pred => {
        html += `
          <tr>
            <td>${pred.partita}</td>
            <td>${pred.segnoPrevisione} (${pred.risultatoCasaPrevisione}-${pred.risultatoTrasfertaPrevisione})</td>
            <td>${pred.risultatoReale}</td>
            <td>${pred.puntiOttenuti}</td>
            <td>${new Date(pred.dataInserimento).toLocaleDateString()}</td>
          </tr>
        `;
      });
      
      tableBody.innerHTML = html;
    }
    
    // Carica le giornate di una lega
    function loadLeagueGameweeks(leagueId, selectElement, callback) {
      if (allGameweeks[leagueId]) {
        populateGameweekSelect(selectElement, allGameweeks[leagueId]);
        if (callback) callback(allGameweeks[leagueId]);
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            const gameweeks = result.data;
            allGameweeks[leagueId] = gameweeks;
            
            populateGameweekSelect(selectElement, gameweeks);
            if (callback) callback(gameweeks);
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'getLeagueGameweeks',
              legaId: leagueId
            })
          }
        });
    }
    
    // Popola il selettore delle giornate
    function populateGameweekSelect(
