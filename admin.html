<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      max-width: 1200px;
    }
    .sidebar {
      background-color: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      height: 100%;
    }
    .sidebar .nav-link {
      color: #333;
      padding: 10px 15px;
      border-radius: 5px;
      margin-bottom: 5px;
      transition: all 0.3s;
    }
    .sidebar .nav-link:hover {
      background-color: #f8f9fa;
    }
    .sidebar .nav-link.active {
      background-color: #0d6efd;
      color: white;
    }
    .sidebar .nav-link i {
      margin-right: 10px;
    }
    .content-area {
      background-color: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      min-height: 85vh;
    }
    .auth-info {
      background-color: #f8f9fa;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 15px;
    }
    .user-name {
      font-weight: bold;
    }
    .card {
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }
    .card-header {
      background-color: #0d6efd;
      color: white;
      border-radius: 8px 8px 0 0 !important;
      font-weight: bold;
    }
    .btn-primary {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }
    .btn-outline-primary {
      color: #0d6efd;
      border-color: #0d6efd;
    }
    .admin-badge {
      background-color: #dc3545;
      color: white;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.8rem;
      margin-left: 5px;
    }
    table.standings {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      border-radius: 8px;
      overflow: hidden;
    }
    table.standings th {
      background-color: #0d6efd;
      color: white;
      font-weight: normal;
    }
    table.standings tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    table.standings td, table.standings th {
      padding: 10px;
    }
    .tab-content {
      padding: 20px 0;
    }
    .alert {
      margin-bottom: 15px;
    }
    .game-date {
      font-size: 0.9rem;
      color: #6c757d;
    }
    .file-upload {
      margin: 25px 0;
      padding: 15px;
      border: 2px dashed #ddd;
      border-radius: 5px;
      text-align: center;
      background-color: #fafafa;
    }
    #content-container {
      display: none;
    }
    #loadingSpinner {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 85vh;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 mb-4">
        <div class="sidebar">
          <div class="auth-info mb-4">
            <div class="user-name" id="userDisplayName">...</div>
            <div class="user-email small text-muted" id="userEmail">...</div>
            <span class="admin-badge">Admin</span>
          </div>
          
          <div class="nav flex-column nav-pills" id="dashboard-tab" role="tablist">
            <a class="nav-link active" id="admin-dashboard-tab" data-bs-toggle="pill" href="#admin-dashboard" role="tab">
              <i class="fas fa-home"></i> Dashboard
            </a>
            <a class="nav-link" id="leagues-tab" data-bs-toggle="pill" href="#leagues" role="tab">
              <i class="fas fa-trophy"></i> Gestione Leghe
            </a>
            <a class="nav-link" id="gameweeks-tab" data-bs-toggle="pill" href="#gameweeks" role="tab">
              <i class="fas fa-calendar-alt"></i> Giornate e Partite
            </a>
            <a class="nav-link" id="teams-tab" data-bs-toggle="pill" href="#teams" role="tab">
              <i class="fas fa-futbol"></i> Squadre e Calciatori
            </a>
            <a class="nav-link" id="users-tab" data-bs-toggle="pill" href="#users" role="tab">
              <i class="fas fa-users"></i> Utenti
            </a>
            <hr>
            <a class="nav-link text-danger" href="#" id="logoutBtn">
              <i class="fas fa-sign-out-alt"></i> Esci
            </a>
          </div>
        </div>
      </div>
      
      <!-- Content Area -->
      <div class="col-md-9">
        <div id="loadingSpinner">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Caricamento...</span>
          </div>
        </div>
        
        <div id="content-container" class="content-area">
          <div class="tab-content">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="admin-dashboard" role="tabpanel">
              <h2 class="mb-4">Pannello Amministratore</h2>
              
              <div class="alert alert-info">
                <h5 class="alert-heading">Benvenuto nel pannello di amministrazione!</h5>
                <p>Da qui puoi gestire tutti gli aspetti del sistema torneo previsioni.</p>
              </div>
              
              <div class="row">
                <div class="col-md-4 mb-4">
                  <div class="card text-center h-100">
                    <div class="card-body">
                      <i class="fas fa-users fa-3x text-primary mb-3"></i>
                      <h4 id="totalUsers">0</h4>
                      <p class="text-muted">Utenti registrati</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 mb-4">
                  <div class="card text-center h-100">
                    <div class="card-body">
                      <i class="fas fa-trophy fa-3x text-primary mb-3"></i>
                      <h4 id="totalLeagues">0</h4>
                      <p class="text-muted">Leghe attive</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 mb-4">
                  <div class="card text-center h-100">
                    <div class="card-body">
                      <i class="fas fa-futbol fa-3x text-primary mb-3"></i>
                      <h4 id="totalMatches">0</h4>
                      <p class="text-muted">Partite registrate</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-4">
                  <div class="card">
                    <div class="card-header">
                      <i class="fas fa-user-plus me-2"></i> Richieste di iscrizione
                    </div>
                    <div class="card-body">
                      <div id="pendingRequestsContainer">
                        <p class="text-center text-muted">Caricamento richieste...</p>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6 mb-4">
                  <div class="card">
                    <div class="card-header">
                      <i class="fas fa-tasks me-2"></i> Azioni rapide
                    </div>
                    <div class="card-body">
                      <div class="list-group">
                        <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="pill" data-bs-target="#leagues">
                          <i class="fas fa-plus-circle me-2"></i> Crea nuova lega
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="pill" data-bs-target="#gameweeks">
                          <i class="fas fa-calendar-plus me-2"></i> Aggiungi nuova giornata
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="pill" data-bs-target="#gameweeks">
                          <i class="fas fa-upload me-2"></i> Importa partite da file
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Leagues Tab -->
            <div class="tab-pane fade" id="leagues" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Gestione Leghe</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createLeagueModal">
                  <i class="fas fa-plus me-1"></i> Crea nuova lega
                </button>
              </div>
              
              <div class="alert alert-success" id="leagueSuccessAlert" style="display: none;"></div>
              
              <div class="card mb-4">
                <div class="card-header">
                  Leghe esistenti
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Nome</th>
                          <th>Descrizione</th>
                          <th>Data creazione</th>
                          <th>Admin</th>
                          <th>Azioni</th>
                        </tr>
                      </thead>
                      <tbody id="leaguesTableBody">
                        <tr>
                          <td colspan="6" class="text-center">Caricamento leghe...</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              
              <div id="leagueMembersContainer" style="display: none;">
                <h3 class="mb-3">Membri della lega: <span id="currentLeagueName"></span></h3>
                <div class="table-responsive">
                  <table class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th>Nome</th>
                        <th>Cognome</th>
                        <th>Email</th>
                        <th>Data iscrizione</th>
                      </tr>
                    </thead>
                    <tbody id="leagueMembersTableBody">
                      <tr>
                        <td colspan="4" class="text-center">Caricamento membri...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              
              <div id="pendingRequestsSection" style="display: none;">
                <h3 class="mb-3">Richieste di iscrizione in attesa</h3>
                <div id="pendingMembersContainer">
                  <p class="text-center text-muted">Nessuna richiesta in attesa</p>
                </div>
              </div>
            </div>
            
            <!-- Gameweeks Tab -->
            <div class="tab-pane fade" id="gameweeks" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Giornate e Partite</h2>
                <div>
                  <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#createGameweekModal">
                    <i class="fas fa-plus me-1"></i> Crea giornata
                  </button>
                  <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#importMatchesModal">
                    <i class="fas fa-upload me-1"></i> Importa partite
                  </button>
                  <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createMatchModal">
                    <i class="fas fa-futbol me-1"></i> Aggiungi partita
                  </button>
                </div>
              </div>
              
              <div class="alert alert-success" id="gameweekSuccessAlert" style="display: none;"></div>
              
              <div class="card mb-4">
                <div class="card-header">
                  Seleziona lega e giornata
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="admin-league-select" class="form-label">Lega</label>
                      <select class="form-select" id="admin-league-select">
                        <option value="">Seleziona una lega</option>
                      </select>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="admin-gameweek-select" class="form-label">Giornata</label>
                      <select class="form-select" id="admin-gameweek-select" disabled>
                        <option value="">Seleziona prima una lega</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              
              <div id="matchesContainer" style="display: none;">
                <h3 class="mb-3">Partite della giornata</h3>
                <div class="table-responsive">
                  <table class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Squadra casa</th>
                        <th>Squadra trasferta</th>
                        <th>Data e ora</th>
                        <th>Risultato</th>
                        <th>Stato</th>
                        <th>Azioni</th>
                      </tr>
                    </thead>
                    <tbody id="matchesTableBody">
                      <tr>
                        <td colspan="7" class="text-center">Nessuna partita trovata</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <!-- Teams Tab -->
            <div class="tab-pane fade" id="teams" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Squadre e Calciatori</h2>
                <div>
                  <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#createTeamModal">
                    <i class="fas fa-plus me-1"></i> Aggiungi squadra
                  </button>
                  <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#importPlayersModal">
                    <i class="fas fa-upload me-1"></i> Importa calciatori
                  </button>
                </div>
              </div>
              
              <div class="alert alert-success" id="teamSuccessAlert" style="display: none;"></div>
              
              <div class="card mb-4">
                <div class="card-header">
                  Squadre registrate
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Nome</th>
                          <th>Abbreviazione</th>
                          <th>Calciatori</th>
                          <th>Azioni</th>
                        </tr>
                      </thead>
                      <tbody id="teamsTableBody">
                        <tr>
                          <td colspan="5" class="text-center">Caricamento squadre...</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              
              <div id="playersContainer" style="display: none;">
                <h3 class="mb-3">Calciatori di: <span id="currentTeamName"></span></h3>
                <div class="table-responsive">
                  <table class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Cognome</th>
                        <th>Ruolo</th>
                        <th>Azioni</th>
                      </tr>
                    </thead>
                    <tbody id="playersTableBody">
                      <tr>
                        <td colspan="5" class="text-center">Caricamento calciatori...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <!-- Users Tab -->
            <div class="tab-pane fade" id="users" role="tabpanel">
              <h2 class="mb-4">Gestione Utenti</h2>
              
              <div class="alert alert-success" id="userSuccessAlert" style="display: none;"></div>
              
              <div class="card">
                <div class="card-header">
                  Utenti registrati
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Nome</th>
                          <th>Cognome</th>
                          <th>Email</th>
                          <th>Data registrazione</th>
                          <th>Ruolo</th>
                          <th>Azioni</th>
                        </tr>
                      </thead>
                      <tbody id="usersTableBody">
                        <tr>
                          <td colspan="7" class="text-center">Caricamento utenti...</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal per creare una nuova lega -->
  <div class="modal fade" id="createLeagueModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Crea nuova lega</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="createLeagueForm">
            <div class="mb-3">
              <label for="leagueName" class="form-label">Nome lega</label>
              <input type="text" class="form-control" id="leagueName" required>
            </div>
            <div class="mb-3">
              <label for="leagueDescription" class="form-label">Descrizione</label>
              <textarea class="form-control" id="leagueDescription" rows="3"></textarea>
            </div>
            <div class="alert alert-danger" id="createLeagueAlert" style="display: none;"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" class="btn btn-primary" id="submitCreateLeague">Crea lega</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal per creare una nuova giornata -->
  <div class="modal fade" id="createGameweekModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Crea nuova giornata</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="createGameweekForm">
            <div class="mb-3">
              <label for="gameweekLeague" class="form-label">Lega</label>
              <select class="form-select" id="gameweekLeague" required>
                <option value="">Seleziona una lega</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="gameweekNumber" class="form-label">Numero giornata</label>
              <input type="number" class="form-control" id="gameweekNumber" min="1" required>
            </div>
            <div class="mb-3">
              <label for="gameweekStartDate" class="form-label">Data inizio</label>
              <input type="date" class="form-control" id="gameweekStartDate" required>
            </div>
            <div class="mb-3">
              <label for="gameweekEndDate" class="form-label">Data fine</label>
              <input type="date" class="form-control" id="gameweekEndDate" required>
            </div>
            <div class="alert alert-danger" id="createGameweekAlert" style="display: none;"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" class="btn btn-primary" id="submitCreateGameweek">Crea giornata</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal per creare una nuova partita -->
  <div class="modal fade" id="createMatchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Aggiungi partita</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="createMatchForm">
            <div class="mb-3">
              <label for="matchGameweek" class="form-label">Giornata</label>
              <select class="form-select" id="matchGameweek" required>
                <option value="">Seleziona una giornata</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="matchHomeTeam" class="form-label">Squadra casa</label>
              <input type="text" class="form-control" id="matchHomeTeam" required>
            </div>
            <div class="mb-3">
              <label for="matchAwayTeam" class="form-label">Squadra trasferta</label>
              <input type="text" class="form-control" id="matchAwayTeam" required>
            </div>
            <div class="mb-3">
              <label for="matchDateTime" class="form-label">Data e ora</label>
              <input type="datetime-local" class="form-control" id="matchDateTime" required>
            </div>
            <div class="alert alert-danger" id="createMatchAlert" style="display: none;"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" class="btn btn-primary" id="submitCreateMatch">Aggiungi partita</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal per aggiornare il risultato di una partita -->
  <div class="modal fade" id="updateMatchResultModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Aggiorna risultato</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="updateMatchResultForm">
            <input type="hidden" id="updateMatchId">
            <div class="mb-3">
              <label id="updateMatchTeams" class="form-label fw-bold">Squadra A vs Squadra B</label>
            </div>
            <div class="mb-3">
              <label for="updateMatchStatus" class="form-label">Stato</label>
              <select class="form-select" id="updateMatchStatus" required>
                <option value="non iniziata">Non iniziata</option>
                <option value="in corso">In corso</option>
                <option value="completata">Completata</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Risultato</label>
              <div class="row">
                <div class="col-5">
                  <input type="number" class="form-control" id="updateHomeScore" min="0" required>
                </div>
                <div class="col-2 text-center pt-2">
                  <span class="fw-bold">-</span>
                </div>
                <div class="col-5">
                  <input type="number" class="form-control" id="updateAwayScore" min="0" required>
                </div>
              </div>
            </div>
            <div class="mb-3" id="scorersGroup">
              <label for="updateMatchScorers" class="form-label">Marcatori</label>
              <small class="text-muted d-block mb-2">Inserisci i nomi dei marcatori separati da virgola</small>
              <textarea class="form-control" id="updateMatchScorers" rows="3"></textarea>
              <small class="text-muted">Necessario solo se la partita è completata e non è 0-0</small>
            </div>
            <div class="alert alert-danger" id="updateMatchAlert" style="display: none;"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" class="btn btn-primary" id="submitUpdateMatch">Aggiorna</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal per importare partite da file -->
  <div class="modal fade" id="importMatchesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Importa partite da file</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="importMatchesForm">
            <div class="mb-3">
              <label for="importLeague" class="form-label">Lega</label>
              <select class="form-select" id="importLeague" required>
                <option value="">Seleziona una lega</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="importFileType" class="form-label">Tipo di file</label>
              <select class="form-select" id="importFileType" required>
                <option value="csv">CSV</option>
                <option value="xlsx">Excel (XLSX)</option>
              </select>
            </div>
            <div class="file-upload">
             <input type="file" id="importFile" class="form-control mb-3" accept=".csv,.xlsx" required>
              <small class="text-muted">
                Il file deve contenere le seguenti colonne: giornata, squadra_casa, squadra_trasferta, data_ora
              </small>
            </div>
            <div class="alert alert-info">
              <h6>Formato del file:</h6>
              <p class="mb-2">Il file deve avere una riga di intestazione con le seguenti colonne:</p>
              <ul>
                <li><strong>giornata</strong>: numero della giornata (es. 1, 2, 3, ...)</li>
                <li><strong>squadra_casa</strong>: nome della squadra di casa</li>
                <li><strong>squadra_trasferta</strong>: nome della squadra in trasferta</li>
                <li><strong>data_ora</strong>: data e ora della partita in formato YYYY-MM-DD HH:MM</li>
              </ul>
            </div>
            <div class="alert alert-danger" id="importMatchesAlert" style="display: none;"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" class="btn btn-primary" id="submitImportMatches">Importa</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Variabili globali
    let currentUser = null;
    let allLeagues = [];
    let allGameweeks = {};
    const apiUrl = '<?= ScriptApp.getService().getUrl() ?>';
    
    // Funzione per verificare l'autenticazione dell'utente
    function checkAuth() {
      const token = localStorage.getItem('torneo_token');
      if (!token) {
        // Reindirizza alla pagina di login
        window.location.href = apiUrl;
        return;
      }
      
      // Carica i dati utente dal localStorage
      const userData = localStorage.getItem('torneo_user');
      if (userData) {
        currentUser = JSON.parse(userData);
        
        // Verifica che l'utente sia admin
        if (currentUser.ruolo !== 'admin') {
          // Reindirizza alla dashboard utente
          window.location.href = apiUrl + '?v=dashboard';
          return;
        }
        
        // Imposta i dati utente nell'interfaccia
        document.getElementById('userDisplayName').textContent = `${currentUser.nome} ${currentUser.cognome}`;
        document.getElementById('userEmail').textContent = currentUser.email;
        
        // Carica i dati iniziali
        loadInitialData();
      } else {
        // Reindirizza alla pagina di login
        window.location.href = apiUrl;
      }
    }
    
    // Carica i dati iniziali della dashboard
    function loadInitialData() {
      // Mostra il contenuto principale
      document.getElementById('loadingSpinner').style.display = 'none';
      document.getElementById('content-container').style.display = 'block';
      
      // Carica tutte le leghe
      loadAllLeagues();
      
      // Carica le richieste di iscrizione pendenti
      loadAllPendingRequests();
      
      // Carica le statistiche
      loadStats();
    }
    
    // Carica tutte le leghe
    function loadAllLeagues() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            allLeagues = result.data;
            
            // Aggiorna la tabella delle leghe
            updateLeaguesTable();
            
            // Popola i selettori delle leghe
            populateLeagueSelects();
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'getAllLeagues'
            })
          }
        });
    }
    
    // Aggiorna la tabella delle leghe
    function updateLeaguesTable() {
      const tableBody = document.getElementById('leaguesTableBody');
      
      if (allLeagues.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Nessuna lega trovata</td></tr>';
        return;
      }
      
      let html = '';
      
      allLeagues.forEach(league => {
        html += `
          <tr>
            <td>${league.id}</td>
            <td>${league.nome}</td>
            <td>${league.descrizione || 'N/D'}</td>
            <td>${new Date(league.dataCreazione).toLocaleDateString()}</td>
            <td>${league.adminId}</td>
            <td>
              <button class="btn btn-sm btn-info view-members-btn" data-league-id="${league.id}" data-league-name="${league.nome}">
                <i class="fas fa-users me-1"></i> Membri
              </button>
              <button class="btn btn-sm btn-warning view-requests-btn" data-league-id="${league.id}" data-league-name="${league.nome}">
                <i class="fas fa-user-plus me-1"></i> Richieste
              </button>
            </td>
          </tr>
        `;
      });
      
      tableBody.innerHTML = html;
      
      // Aggiungi event listeners ai pulsanti
      document.querySelectorAll('.view-members-btn').forEach(button => {
        button.addEventListener('click', function() {
          const leagueId = this.getAttribute('data-league-id');
          const leagueName = this.getAttribute('data-league-name');
          loadLeagueMembers(leagueId, leagueName);
        });
      });
      
      document.querySelectorAll('.view-requests-btn').forEach(button => {
        button.addEventListener('click', function() {
          const leagueId = this.getAttribute('data-league-id');
          const leagueName = this.getAttribute('data-league-name');
          loadPendingRequests(leagueId, leagueName);
        });
      });
    }
    
    // Popola i selettori delle leghe
    function populateLeagueSelects() {
      const selectors = [
        document.getElementById('gameweekLeague'),
        document.getElementById('admin-league-select'),
        document.getElementById('importLeague')
      ];
      
      selectors.forEach(selector => {
        if (selector) {
          selector.innerHTML = '<option value="">Seleziona una lega</option>';
          
          allLeagues.forEach(league => {
            selector.innerHTML += `<option value="${league.id}">${league.nome}</option>`;
          });
        }
      });
    }
    
    // Carica i membri di una lega
    function loadLeagueMembers(leagueId, leagueName) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            const members = result.data;
            const membersTableBody = document.getElementById('leagueMembersTableBody');
            
            // Aggiorna il nome della lega corrente
            document.getElementById('currentLeagueName').textContent = leagueName;
            
            // Mostra il contenitore dei membri
            document.getElementById('leagueMembersContainer').style.display = 'block';
            
            // Nascondi il contenitore delle richieste pendenti
            document.getElementById('pendingRequestsSection').style.display = 'none';
            
            if (members.length === 0) {
              membersTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Nessun membro trovato</td></tr>';
              return;
            }
            
            let html = '';
            
            members.forEach(member => {
              html += `
                <tr>
                  <td>${member.nome}</td>
                  <td>${member.cognome}</td>
                  <td>${member.email}</td>
                  <td>${new Date(member.dataIscrizione).toLocaleDateString()}</td>
                </tr>
              `;
            });
            
            membersTableBody.innerHTML = html;
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'getLeagueMembers',
              legaId: leagueId
            })
          }
        });
    }
    
    // Carica le richieste pendenti per una lega
    function loadPendingRequests(leagueId, leagueName) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            const requests = result.data;
            const requestsContainer = document.getElementById('pendingMembersContainer');
            
            // Mostra il contenitore delle richieste pendenti
            document.getElementById('pendingRequestsSection').style.display = 'block';
            
            // Nascondi il contenitore dei membri
            document.getElementById('leagueMembersContainer').style.display = 'none';
            
            if (requests.length === 0) {
              requestsContainer.innerHTML = '<p class="text-center text-muted">Nessuna richiesta in attesa</p>';
              return;
            }
            
            let html = '<div class="list-group">';
            
            requests.forEach(request => {
              html += `
                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                  <div>
                    <h5 class="mb-1">${request.nome} ${request.cognome}</h5>
                    <p class="mb-1 small">${request.email}</p>
                    <small class="text-muted">Richiesta il ${new Date(request.dataRichiesta).toLocaleDateString()}</small>
                  </div>
                  <div>
                    <button class="btn btn-sm btn-success approve-request-btn" data-member-id="${request.memberId}">
                      <i class="fas fa-check me-1"></i> Approva
                    </button>
                    <button class="btn btn-sm btn-danger reject-request-btn" data-member-id="${request.memberId}">
                      <i class="fas fa-times me-1"></i> Rifiuta
                    </button>
                  </div>
                </div>
              `;
            });
            
            html += '</div>';
            requestsContainer.innerHTML = html;
            
            // Aggiungi event listeners ai pulsanti
            document.querySelectorAll('.approve-request-btn').forEach(button => {
              button.addEventListener('click', function() {
                const memberId = this.getAttribute('data-member-id');
                updateMembershipStatus(memberId, 'approvato', leagueId);
              });
            });
            
            document.querySelectorAll('.reject-request-btn').forEach(button => {
              button.addEventListener('click', function() {
                const memberId = this.getAttribute('data-member-id');
                updateMembershipStatus(memberId, 'rifiutato', leagueId);
              });
            });
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'getPendingMembershipRequests',
              legaId: leagueId
            })
          }
        });
    }
    
    // Aggiorna lo stato di una richiesta di iscrizione
    function updateMembershipStatus(memberId, status, leagueId) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // Ricarica le richieste pendenti
            loadPendingRequests(leagueId);
            
            // Mostra messaggio di successo
            const alert = document.getElementById('leagueSuccessAlert');
            alert.textContent = result.message;
            alert.style.display = 'block';
            
            // Nascondi il messaggio dopo 3 secondi
            setTimeout(() => {
              alert.style.display = 'none';
            }, 3000);
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'updateMembershipStatus',
              memberId: memberId,
              status: status
            })
          }
        });
    }
    
    // Carica tutte le richieste di iscrizione pendenti
    function loadAllPendingRequests() {
      const container = document.getElementById('pendingRequestsContainer');
      
      // Lista per memorizzare tutte le richieste pendenti
      let allPendingRequests = [];
      
      // Funzione per controllare se abbiamo richieste da tutte le leghe
      function checkAllRequestsLoaded() {
        if (allPendingRequests.length === 0) {
          container.innerHTML = '<p class="text-center text-muted">Nessuna richiesta in attesa</p>';
          return;
        }
        
        let html = '<div class="list-group">';
        
        allPendingRequests.forEach(request => {
          html += `
            <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
              <div>
                <h5 class="mb-1">${request.nome} ${request.cognome}</h5>
                <p class="mb-1 small">
                  ${request.email} - 
                  <span class="text-primary">${request.legaNome}</span>
                </p>
                <small class="text-muted">Richiesta il ${new Date(request.dataRichiesta).toLocaleDateString()}</small>
              </div>
              <div>
                <button class="btn btn-sm btn-success approve-request-btn" data-member-id="${request.memberId}" data-league-id="${request.legaId}">
                  <i class="fas fa-check me-1"></i> Approva
                </button>
                <button class="btn btn-sm btn-danger reject-request-btn" data-member-id="${request.memberId}" data-league-id="${request.legaId}">
                  <i class="fas fa-times me-1"></i> Rifiuta
                </button>
              </div>
            </div>
          `;
        });
        
        html += '</div>';
        container.innerHTML = html;
        
        // Aggiungi event listeners ai pulsanti
        document.querySelectorAll('.approve-request-btn').forEach(button => {
          button.addEventListener('click', function() {
            const memberId = this.getAttribute('data-member-id');
            const leagueId = this.getAttribute('data-league-id');
            updateMembershipStatus(memberId, 'approvato', leagueId);
            loadAllPendingRequests(); // Ricarica tutte le richieste
          });
        });
        
        document.querySelectorAll('.reject-request-btn').forEach(button => {
          button.addEventListener('click', function() {
            const memberId = this.getAttribute('data-member-id');
            const leagueId = this.getAttribute('data-league-id');
            updateMembershipStatus(memberId, 'rifiutato', leagueId);
            loadAllPendingRequests(); // Ricarica tutte le richieste
          });
        });
      }
      
      // Imposta un timeout se non ci sono leghe o richieste
      const timeout = setTimeout(() => {
        container.innerHTML = '<p class="text-center text-muted">Nessuna richiesta in attesa</p>';
      }, 5000);
      
      // Carica le richieste per ogni lega
      function loadRequestsForLeague(league, index, total) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success && result.data.length > 0) {
              // Aggiungi il nome della lega a ogni richiesta
              const requests = result.data.map(req => ({
                ...req,
                legaNome: league.nome,
                legaId: league.id
              }));
              
              allPendingRequests = [...allPendingRequests, ...requests];
            }
            
            // Se è l'ultima lega, aggiorna l'interfaccia
            if (index === total - 1) {
              clearTimeout(timeout);
              checkAllRequestsLoaded();
            }
          })
          .doPost({
            postData: {
              contents: JSON.stringify({
                action: 'getPendingMembershipRequests',
                legaId: league.id
              })
            }
          });
      }
      
      // Inizia il caricamento delle richieste
      if (allLeagues.length === 0) {
        setTimeout(() => {
          if (allLeagues.length > 0) {
            allLeagues.forEach((league, index) => {
              loadRequestsForLeague(league, index, allLeagues.length);
            });
          } else {
            clearTimeout(timeout);
            checkAllRequestsLoaded();
          }
        }, 1000); // Aspetta che le leghe siano caricate
      } else {
        allLeagues.forEach((league, index) => {
          loadRequestsForLeague(league, index, allLeagues.length);
        });
      }
    }
    
    // Carica le statistiche
    function loadStats() {
      // Conteggio utenti (esempio - nella realtà dovresti avere una API)
      document.getElementById('totalUsers').textContent = "...";
      document.getElementById('totalLeagues').textContent = "...";
      document.getElementById('totalMatches').textContent = "...";
      
      // In una implementazione reale, aggiungeresti chiamate API per ottenere queste statistiche
      setTimeout(() => {
        if (allLeagues.length > 0) {
          document.getElementById('totalLeagues').textContent = allLeagues.length;
        }
      }, 1000);
    }
    
    // Carica le partite di una giornata
    function loadGameweekMatches(gameweekId) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            const matches = result.data;
            const matchesTableBody = document.getElementById('matchesTableBody');
            
            // Mostra il contenitore delle partite
            document.getElementById('matchesContainer').style.display = 'block';
            
            if (matches.length === 0) {
              matchesTableBody.innerHTML = '<tr><td colspan="7" class="text-center">Nessuna partita trovata</td></tr>';
              return;
            }
            
            let html = '';
            
            matches.forEach(match => {
              // Formatta la data
              const matchDate = new Date(match.dataOra).toLocaleString();
              
              // Formatta il risultato
              let resultText = 'N/D';
              if (match.stato !== 'non iniziata') {
                resultText = `${match.risultatoCasa}-${match.risultatoTrasferta}`;
              }
              
              // Formatta lo stato
              let statusBadge = '';
              if (match.stato === 'completata') {
                statusBadge = '<span class="badge bg-success">Completata</span>';
              } else if (match.stato === 'in corso') {
                statusBadge = '<span class="badge bg-warning text-dark">In corso</span>';
              } else {
                statusBadge = '<span class="badge bg-info text-dark">Non iniziata</span>';
              }
              
              html += `
                <tr>
                  <td>${match.id}</td>
                  <td>${match.squadraCasa}</td>
                  <td>${match.squadraTrasferta}</td>
                  <td>${matchDate}</td>
                  <td>${resultText}</td>
                  <td>${statusBadge}</td>
                  <td>
                    <button class="btn btn-sm btn-primary update-result-btn" 
                      data-match-id="${match.id}" 
                      data-home-team="${match.squadraCasa}" 
                      data-away-team="${match.squadraTrasferta}"
                      data-home-score="${match.risultatoCasa || 0}"
                      data-away-score="${match.risultatoTrasferta || 0}"
                      data-status="${match.stato}">
                      <i class="fas fa-edit me-1"></i> Risultato
                    </button>
                  </td>
                </tr>
              `;
            });
            
            matchesTableBody.innerHTML = html;
            
            // Aggiungi event listeners ai pulsanti
            document.querySelectorAll('.update-result-btn').forEach(button => {
              button.addEventListener('click', function() {
                const matchId = this.getAttribute('data-match-id');
                const homeTeam = this.getAttribute('data-home-team');
                const awayTeam = this.getAttribute('data-away-team');
                const homeScore = this.getAttribute('data-home-score');
                const awayScore = this.getAttribute('data-away-score');
                const status = this.getAttribute('data-status');
                
                openUpdateMatchResultModal(matchId, homeTeam, awayTeam, homeScore, awayScore, status);
              });
            });
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'getGameweekMatches',
              gameweekId: gameweekId
            })
          }
        });
    }
    
    // Apre il modal per aggiornare il risultato di una partita
    function openUpdateMatchResultModal(matchId, homeTeam, awayTeam, homeScore, awayScore, status) {
      // Imposta i dati della partita
      document.getElementById('updateMatchId').value = matchId;
      document.getElementById('updateMatchTeams').textContent = `${homeTeam} vs ${awayTeam}`;
      document.getElementById('updateHomeScore').value = homeScore;
      document.getElementById('updateAwayScore').value = awayScore;
      document.getElementById('updateMatchStatus').value = status;
      
      // Resetta l'alert
      document.getElementById('updateMatchAlert').style.display = 'none';
      
      // Mostra il modal
      const modal = new bootstrap.Modal(document.getElementById('updateMatchResultModal'));
      modal.show();
    }
    
    // Crea una nuova lega
    function createLeague() {
      const nome = document.getElementById('leagueName').value;
      const descrizione = document.getElementById('leagueDescription').value;
      
      if (!nome) {
        document.getElementById('createLeagueAlert').textContent = 'Inserisci un nome per la lega';
        document.getElementById('createLeagueAlert').style.display = 'block';
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // Chiudi il modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('createLeagueModal'));
            modal.hide();
            
            // Mostra messaggio di successo
            const alert = document.getElementById('leagueSuccessAlert');
            alert.textContent = result.message;
            alert.style.display = 'block';
            
            // Nascondi il messaggio dopo 3 secondi
            setTimeout(() => {
              alert.style.display = 'none';
            }, 3000);
            
            // Ricarica le leghe
            loadAllLeagues();
          } else {
            document.getElementById('createLeagueAlert').textContent = result.message;
            document.getElementById('createLeagueAlert').style.display = 'block';
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'createLeague',
              nome: nome,
              descrizione: descrizione,
              adminId: currentUser.id
            })
          }
        });
    }
    
    // Crea una nuova giornata
    function createGameweek() {
      const legaId = document.getElementById('gameweekLeague').value;
      const numero = document.getElementById('gameweekNumber').value;
      const dataInizio = document.getElementById('gameweekStartDate').value;
      const dataFine = document.getElementById('gameweekEndDate').value;
      
      if (!legaId || !numero || !dataInizio || !dataFine) {
        document.getElementById('createGameweekAlert').textContent = 'Compila tutti i campi';
        document.getElementById('createGameweekAlert').style.display = 'block';
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // Chiudi il modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('createGameweekModal'));
            modal.hide();
            
            // Mostra messaggio di successo
            const alert = document.getElementById('gameweekSuccessAlert');
            alert.textContent = result.message;
            alert.style.display = 'block';
            
            // Nascondi il messaggio dopo 3 secondi
            setTimeout(() => {
              alert.style.display = 'none';
            }, 3000);
            
            // Aggiorna la lista delle giornate se la lega corrente è selezionata
            const selectedLeague = document.getElementById('admin-league-select').value;
            if (selectedLeague === legaId) {
              loadLeagueGameweeks(legaId);
            }
          } else {
            document.getElementById('createGameweekAlert').textContent = result.message;
            document.getElementById('createGameweekAlert').style.display = 'block';
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'createGameweek',
              legaId: legaId,
              numero: numero,
              dataInizio: dataInizio,
              dataFine: dataFine
            })
          }
        });
    }
    
    // Crea una nuova partita
    function createMatch() {
      const giornataId = document.getElementById('matchGameweek').value;
      const squadraCasa = document.getElementById('matchHomeTeam').value;
      const squadraTrasferta = document.getElementById('matchAwayTeam').value;
      const dataOra = document.getElementById('matchDateTime').value;
      
      if (!giornataId || !squadraCasa || !squadraTrasferta || !dataOra) {
        document.getElementById('createMatchAlert').textContent = 'Compila tutti i campi';
        document.getElementById('createMatchAlert').style.display = 'block';
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // Chiudi il modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('createMatchModal'));
            modal.hide();
            
            // Mostra messaggio di successo
            const alert = document.getElementById('gameweekSuccessAlert');
            alert.textContent = result.message;
            alert.style.display = 'block';
            
            // Nascondi il messaggio dopo 3 secondi
            setTimeout(() => {
              alert.style.display = 'none';
            }, 3000);
            
            // Aggiorna la lista delle partite se la giornata corrente è selezionata
            const selectedGameweek = document.getElementById('admin-gameweek-select').value;
            if (selectedGameweek === giornataId) {
              loadGameweekMatches(giornataId);
            }
          } else {
            document.getElementById('createMatchAlert').textContent = result.message;
            document.getElementById('createMatchAlert').style.display = 'block';
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'createMatch',
              giornataId: giornataId,
              squadraCasa: squadraCasa,
              squadraTrasferta: squadraTrasferta,
              dataOra: dataOra
            })
          }
        });
    }
    
    // Aggiorna il risultato di una partita
    function updateMatchResult() {
      const matchId = document.getElementById('updateMatchId').value;
      const homeScore = document.getElementById('updateHomeScore').value;
      const awayScore = document.getElementById('updateAwayScore').value;
      const status = document.getElementById('updateMatchStatus').value;
      const scorers = document.getElementById('updateMatchScorers').value;
      
      if (homeScore === '' || awayScore === '') {
        document.getElementById('updateMatchAlert').textContent = 'Inserisci un risultato completo';
        document.getElementById('updateMatchAlert').style.display = 'block';
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // Chiudi il modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('updateMatchResultModal'));
            modal.hide();
            
            // Mostra messaggio di successo
            const alert = document.getElementById('gameweekSuccessAlert');
            alert.textContent = result.message;
            alert.style.display = 'block';
            
            // Nascondi il messaggio dopo 3 secondi
            setTimeout(() => {
              alert.style.display = 'none';
            }, 3000);
            
            // Se la partita è completata e ci sono marcatori, verifica i marcatori
            if (status === 'completata' && (parseInt(homeScore) > 0 || parseInt(awayScore) > 0) && scorers.trim()) {
              google.script.run
                .withSuccessHandler(function(scorersResult) {
                  // Non è necessario fare nulla qui, è solo per assicurarsi che i marcatori siano verificati
                })
                .doPost({
                  postData: {
                    contents: JSON.stringify({
                      action: 'verifyScorers',
                      matchId: matchId,
                      realScorers: scorers
                    })
                  }
                });
            }
            
            // Aggiorna la lista delle partite
            const selectedGameweek = document.getElementById('admin-gameweek-select').value;
            if (selectedGameweek) {
              loadGameweekMatches(selectedGameweek);
            }
          } else {
            document.getElementById('updateMatchAlert').textContent = result.message;
            document.getElementById('updateMatchAlert').style.display = 'block';
          }
        })
        .doPost({
          postData: {
            contents: JSON.stringify({
              action: 'updateMatchResult',
              matchId: matchId,
              risultatoCasa: homeScore,
              risultatoTrasferta: awayScore,
              nuovo<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      max-width: 1200px;
    }
    .sidebar {
      background-color: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      height: 100%;
    }
    .sidebar .nav-link {
      color: #333;
      padding: 10px 15px;
      border-radius: 5px;
      margin-bottom: 5px;
      transition: all 0.3s;
    }
    .sidebar .nav-link:hover {
      background-color: #f8f9fa;
    }
    .sidebar .nav-link.active {
      background-color: #0d6efd;
      color: white;
    }
    .sidebar .nav-link i {
      margin-right: 10px;
    }
    .content-area {
      background-color: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      min-height: 85vh;
    }
    .auth-info {
      background-color: #f8f9fa;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 15px;
    }
    .user-name {
      font-weight: bold;
    }
    .card {
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }
    .card-header {
      background-color: #0d6efd;
      color: white;
      border-radius: 8px 8px 0 0 !important;
      font-weight: bold;
    }
    .btn-primary {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }
    .btn-outline-primary {
      color: #0d6efd;
      border-color: #0d6efd;
    }
    .admin-badge {
      background-color: #dc3545;
      color: white;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.8rem;
      margin-left: 5px;
    }
    table.standings {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      border-radius: 8px;
      overflow: hidden;
    }
    table.standings th {
      background-color: #0d6efd;
      color: white;
      font-weight: normal;
    }
    table.standings tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    table.standings td, table.standings th {
      padding: 10px;
    }
    .tab-content {
      padding: 20px 0;
    }
    .alert {
      margin-bottom: 15px;
    }
    .game-date {
      font-size: 0.9rem;
      color: #6c757d;
    }
    .file-upload {
      margin: 25px 0;
      padding: 15px;
      border: 2px dashed #ddd;
      border-radius: 5px;
      text-align: center;
      background-color: #fafafa;
    }
    #content-container {
      display: none;
    }
    #loadingSpinner {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 85vh;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 mb-4">
        <div class="sidebar">
          <div class="auth-info mb-4">
            <div class="user-name" id="userDisplayName">...</div>
            <div class="user-email small text-muted" id="userEmail">...</div>
            <span class="admin-badge">Admin</span>
          </div>
          
          <div class="nav flex-column nav-pills" id="dashboard-tab" role="tablist">
            <a class="nav-link active" id="admin-dashboard-tab" data-bs-toggle="pill" href="#admin-dashboard" role="tab">
              <i class="fas fa-home"></i> Dashboard
            </a>
            <a class="nav-link" id="leagues-tab" data-bs-toggle="pill" href="#leagues" role="tab">
              <i class="fas fa-trophy"></i> Gestione Leghe
            </a>
            <a class="nav-link" id="gameweeks-tab" data-bs-toggle="pill" href="#gameweeks" role="tab">
              <i class="fas fa-calendar-alt"></i> Giornate e Partite
            </a>
            <a class="nav-link" id="teams-tab" data-bs-toggle="pill" href="#teams" role="tab">
              <i class="fas fa-futbol"></i> Squadre e Calciatori
            </a>
            <a class="nav-link" id="users-tab" data-bs-toggle="pill" href="#users" role="tab">
              <i class="fas fa-users"></i> Utenti
            </a>
            <hr>
            <a class="nav-link text-danger" href="#" id="logoutBtn">
              <i class="fas fa-sign-out-alt"></i> Esci
            </a>
          </div>
        </div>
      </div>
      
      <!-- Content Area -->
      <div class="col-md-9">
        <div id="loadingSpinner">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Caricamento...</span>
          </div>
        </div>
        
        <div id="content-container" class="content-area">
          <div class="tab-content">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="admin-dashboard" role="tabpanel">
              <h2 class="mb-4">Pannello Amministratore</h2>
              
              <div class="alert alert-info">
                <h5 class="alert-heading">Benvenuto nel pannello di amministrazione!</h5>
                <p>Da qui puoi gestire tutti gli aspetti del sistema torneo previsioni.</p>
              </div>
              
              <div class="row">
                <div class="col-md-4 mb-4">
                  <div class="card text-center h-100">
                    <div class="card-body">
                      <i class="fas fa-users fa-3x text-primary mb-3"></i>
                      <h4 id="totalUsers">0</h4>
                      <p class="text-muted">Utenti registrati</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 mb-4">
                  <div class="card text-center h-100">
                    <div class="card-body">
                      <i class="fas fa-trophy fa-3x text-primary mb-3"></i>
                      <h4 id="totalLeagues">0</h4>
                      <p class="text-muted">Leghe attive</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 mb-4">
                  <div class="card text-center h-100">
                    <div class="card-body">
                      <i class="fas fa-futbol fa-3x text-primary mb-3"></i>
                      <h4 id="totalMatches">0</h4>
                      <p class="text-muted">Partite registrate</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-4">
                  <div class="card">
                    <div class="card-header">
                      <i class="fas fa-user-plus me-2"></i> Richieste di iscrizione
                    </div>
                    <div class="card-body">
                      <div id="pendingRequestsContainer">
                        <p class="text-center text-muted">Caricamento richieste...</p>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6 mb-4">
                  <div class="card">
                    <div class="card-header">
                      <i class="fas fa-tasks me-2"></i> Azioni rapide
                    </div>
                    <div class="card-body">
                      <div class="list-group">
                        <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="pill" data-bs-target="#leagues">
                          <i class="fas fa-plus-circle me-2"></i> Crea nuova lega
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="pill" data-bs-target="#gameweeks">
                          <i class="fas fa-calendar-plus me-2"></i> Aggiungi nuova giornata
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="pill" data-bs-target="#gameweeks">
                          <i class="fas fa-upload me-2"></i> Importa partite da file
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Leagues Tab -->
            <div class="tab-pane fade" id="leagues" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Gestione Leghe</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createLeagueModal">
                  <i class="fas fa-plus me-1"></i> Crea nuova lega
                </button>
              </div>
              
              <div class="alert alert-success" id="leagueSuccessAlert" style="display: none;"></div>
              
              <div class="card mb-4">
                <div class="card-header">
                  Leghe esistenti
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Nome</th>
                          <th>Descrizione</th>
                          <th>Data creazione</th>
                          <th>Admin</th>
                          <th>Azioni</th>
                        </tr>
                      </thead>
                      <tbody id="leaguesTableBody">
                        <tr>
                          <td colspan="6" class="text-center">Caricamento leghe...</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              
              <div id="leagueMembersContainer" style="display: none;">
                <h3 class="mb-3">Membri della lega: <span id="currentLeagueName"></span></h3>
                <div class="table-responsive">
                  <table class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th>Nome</th>
                        <th>Cognome</th>
                        <th>Email</th>
                        <th>Data iscrizione</th>
                      </tr>
                    </thead>
                    <tbody id="leagueMembersTableBody">
                      <tr>
                        <td colspan="4" class="text-center">Caricamento membri...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              
              <div id="pendingRequestsSection" style="display: none;">
                <h3 class="mb-3">Richieste di iscrizione in attesa</h3>
                <div id="pendingMembersContainer">
                  <p class="text-center text-muted">Nessuna richiesta in attesa</p>
                </div>
              </div>
            </div>
            
            <!-- Gameweeks Tab -->
            <div class="tab-pane fade" id="gameweeks" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Giornate e Partite</h2>
                <div>
                  <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#createGameweekModal">
                    <i class="fas fa-plus me-1"></i> Crea giornata
                  </button>
                  <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#importMatchesModal">
                    <i class="fas fa-upload me-1"></i> Importa partite
                  </button>
                  <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createMatchModal">
                    <i class="fas fa-futbol me-1"></i> Aggiungi partita
                  </button>
                </div>
              </div>
              
              <div class="alert alert-success" id="gameweekSuccessAlert" style="display: none;"></div>
              
              <div class="card mb-4">
                <div class="card-header">
                  Seleziona lega e giornata
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="admin-league-select" class="form-label">Lega</label>
                      <select class="form-select" id="admin-league-select">
                        <option value="">Seleziona una lega</option>
                      </select>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="admin-gameweek-select" class="form-label">Giornata</label>
                      <select class="form-select" id="admin-gameweek-select" disabled>
                        <option value="">Seleziona prima una lega</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              
              <div id="matchesContainer" style="display: none;">
                <h3 class="mb-3">Partite della giornata</h3>
                <div class="table-responsive">
                  <table class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Squadra casa</th>
                        <th>Squadra trasferta</th>
                        <th>Data e ora</th>
                        <th>Risultato</th>
                        <th>Stato</th>
                        <th>Azioni</th>
                      </tr>
                    </thead>
                    <tbody id="matchesTableBody">
                      <tr>
                        <td colspan="7" class="text-center">Nessuna partita trovata</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <!-- Teams Tab -->
            <div class="tab-pane fade" id="teams" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Squadre e Calciatori</h2>
                <div>
                  <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#createTeamModal">
                    <i class="fas fa-plus me-1"></i> Aggiungi squadra
                  </button>
                  <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#importPlayersModal">
                    <i class="fas fa-upload me-1"></i> Importa calciatori
                  </button>
                </div>
              </div>
              
              <div class="alert alert-success" id="teamSuccessAlert" style="display: none;"></div>
              
              <div class="card mb-4">
                <div class="card-header">
                  Squadre registrate
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Nome</th>
                          <th>Abbreviazione</th>
                          <th>Calciatori</th>
                          <th>Azioni</th>
                        </tr>
                      </thead>
                      <tbody id="teamsTableBody">
                        <tr>
                          <td colspan="5" class="text-center">Caricamento squadre...</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              
              <div id="playersContainer" style="display: none;">
                <h3 class="mb-3">Calciatori di: <span id="currentTeamName"></span></h3>
                <div class="table-responsive">
                  <table class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Cognome</th>
                        <th>Ruolo</th>
                        <th>Azioni</th>
                      </tr>
                    </thead>
                    <tbody id="playersTableBody">
                      <tr>
                        <td colspan="5" class="text-center">Caricamento calciatori...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <!-- Users Tab -->
            <div class="tab-pane fade" id="users" role="tabpanel">
              <h2 class="mb-4">Gestione Utenti</h2>
              
              <div class="alert alert-success" id="userSuccessAlert" style="display: none;"></div>
              
              <div class="card">
                <div class="card-header">
                  Utenti registrati
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Nome</th>
                          <th>Cognome</th>
                          <th>Email</th>
                          <th>Data registrazione</th>
                          <th>Ruolo</th>
                          <th>Azioni</th>
                        </tr>
                      </thead>
                      <tbody id="usersTableBody">
                        <tr>
                          <td colspan="7" class="text-center">Caricamento utenti...</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal per creare una nuova lega -->
  <div class="modal fade" id="createLeagueModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Crea nuova lega</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="createLeagueForm">
            <div class="mb-3">
              <label for="leagueName" class="form-label">Nome lega</label>
              <input type="text" class="form-control" id="leagueName" required>
            </div>
            <div class="mb-3">
              <label for="leagueDescription" class="form-label">Descrizione</label>
              <textarea class="form-control" id="leagueDescription" rows="3"></textarea>
            </div>
            <div class="alert alert-danger" id="createLeagueAlert" style="display: none;"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" class="btn btn-primary" id="submitCreateLeague">Crea lega</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal per creare una nuova giornata -->
  <div class="modal fade" id="createGameweekModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Crea nuova giornata</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="createGameweekForm">
            <div class="mb-3">
              <label for="gameweekLeague" class="form-label">Lega</label>
              <select class="form-select" id="gameweekLeague" required>
                <option value="">Seleziona una lega</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="gameweekNumber" class="form-label">Numero giornata</label>
              <input type="number" class="form-control" id="gameweekNumber" min="1" required>
            </div>
            <div class="mb-3">
              <label for="gameweekStartDate" class="form-label">Data inizio</label>
              <input type="date" class="form-control" id="gameweekStartDate" required>
            </div>
            <div class="mb-3">
              <label for="gameweekEndDate" class="form-label">Data fine</label>
              <input type="date" class="form-control" id="gameweekEndDate" required>
            </div>
            <div class="alert alert-danger" id="createGameweekAlert" style="display: none;"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" class="btn btn-primary" id="submitCreateGameweek">Crea giornata</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal per creare una nuova partita -->
  <div class="modal fade" id="createMatchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Aggiungi partita</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="createMatchForm">
            <div class="mb-3">
              <label for="matchGameweek" class="form-label">Giornata</label>
              <select class="form-select" id="matchGameweek" required>
                <option value="">Seleziona una giornata</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="matchHomeTeam" class="form-label">Squadra casa</label>
              <input type="text" class="form-control" id="matchHomeTeam" required>
            </div>
            <div class="mb-3">
              <label for="matchAwayTeam" class="form-label">Squadra trasferta</label>
              <input type="text" class="form-control" id="matchAwayTeam" required>
            </div>
            <div class="mb-3">
              <label for="matchDateTime" class="form-label">Data e ora</label>
              <input type="datetime-local" class="form-control" id="matchDateTime" required>
            </div>
            <div class="alert alert-danger" id="createMatchAlert" style="display: none;"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" class="btn btn-primary" id="submitCreateMatch">Aggiungi partita</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal per aggiornare il risultato di una partita -->
  <div class="modal fade" id="updateMatchResultModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Aggiorna risultato</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="updateMatchResultForm">
            <input type="hidden" id="updateMatchId">
            <div class="mb-3">
              <label id="updateMatchTeams" class="form-label fw-bold">Squadra A vs Squadra B</label>
            </div>
            <div class="mb-3">
              <label for="updateMatchStatus" class="form-label">Stato</label>
              <select class="form-select" id="updateMatchStatus" required>
                <option value="non iniziata">Non iniziata</option>
                <option value="in corso">In corso</option>
                <option value="completata">Completata</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Risultato</label>
              <div class="row">
                <div class="col-5">
                  <input type="number" class="form-control" id="updateHomeScore" min="0" required>
                </div>
                <div class="col-2 text-center pt-2">
                  <span class="fw-bold">-</span>
                </div>
                <div class="col-5">
                  <input type="number" class="form-control" id="updateAwayScore" min="0" required>
                </div>
              </div>
            </div>
            <div class="mb-3" id="scorersGroup">
              <label for="updateMatchScorers" class="form-label">Marcatori</label>
              <small class="text-muted d-block mb-2">Inserisci i nomi dei marcatori separati da virgola</small>
              <textarea class="form-control" id="updateMatchScorers" rows="3"></textarea>
              <small class="text-muted">Necessario solo se la partita è completata e non è 0-0</small>
            </div>
            <div class="alert alert-danger" id="updateMatchAlert" style="display: none;"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" class="btn btn-primary" id="submitUpdateMatch">Aggiorna</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal per importare partite da file -->
  <div class="modal fade" id="importMatchesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Importa partite da file</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="importMatchesForm">
            <div class="mb-3">
              <label for="importLeague" class="form-label">Lega</label>
              <select class="form-select" id="importLeague" required>
                <option value="">Seleziona una lega</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="importFileType" class="form-label">Tipo di file</label>
              <select class="form-select" id="importFileType" required>
                <option value="csv">CSV</option>
                <option value="xlsx">Excel (XLSX)</option>
              </select>
            </div>
            <div class="file-upload">
              <input type="file" id="importFile" class="form-control mb-3" accept=".csv,.xlsx" required>
              <small class="text-muted">
                Il file deve contenere le seguenti colonne: giornata, squadra_casa, squa
